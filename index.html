<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üçâ Fruit Ninja</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 10;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 12px 18px;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .stat-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            margin: 4px 0;
        }

        .stat-row span {
            font-weight: bold;
        }

        .money { color: #4cd137; }
        .score { color: #ffd700; }

        #lives {
            display: flex;
            gap: 5px;
        }

        .heart {
            font-size: 24px;
            filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.5));
            transition: all 0.3s;
        }

        .heart.lost {
            opacity: 0.3;
            transform: scale(0.8);
        }

        /* –ú–µ–Ω—é */
        #menu, #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
        }

        .menu-title {
            font-size: 48px;
            margin-bottom: 10px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .menu-subtitle {
            color: #aaa;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* –¢–∞–±–ª–∏—Ü–∞ –Ω–∞–≥—Ä–∞–¥ */
        .rewards-table {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 25px;
            width: 100%;
            max-width: 320px;
        }

        .rewards-title {
            color: #ffd700;
            font-size: 16px;
            text-align: center;
            margin-bottom: 12px;
            font-weight: bold;
        }

        .reward-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-radius: 8px;
            margin: 4px 0;
            color: white;
            font-size: 14px;
        }

        .reward-row:nth-child(odd) {
            background: rgba(255, 255, 255, 0.05);
        }

        .reward-emoji {
            font-size: 24px;
        }

        .reward-name {
            flex: 1;
            margin-left: 10px;
        }

        .reward-price {
            color: #4cd137;
            font-weight: bold;
        }

        .reward-speed {
            color: #74b9ff;
            font-size: 12px;
            margin-left: 10px;
        }

        .menu-btn {
            background: linear-gradient(135deg, #4cd137, #44bd32);
            border: none;
            color: white;
            font-size: 22px;
            font-weight: bold;
            padding: 18px 50px;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 10px 30px rgba(76, 209, 55, 0.4);
            transition: all 0.3s;
        }

        .menu-btn:hover {
            transform: scale(1.05);
        }

        .menu-btn:active {
            transform: scale(0.95);
        }

        .menu-btn.secondary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            box-shadow: 0 10px 30px rgba(238, 90, 36, 0.4);
        }

        #gameOver {
            display: none;
        }

        .game-over-title {
            color: #ff6b6b;
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .earnings-box {
            background: linear-gradient(135deg, #4cd137, #44bd32);
            border-radius: 20px;
            padding: 20px 40px;
            margin-bottom: 20px;
            text-align: center;
        }

        .earnings-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .earnings-amount {
            color: white;
            font-size: 42px;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 25px;
            width: 100%;
            max-width: 300px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .stat-card-value {
            color: #ffd700;
            font-size: 24px;
            font-weight: bold;
        }

        .stat-card-label {
            color: #aaa;
            font-size: 12px;
        }

        /* –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –Ω–∞–≥—Ä–∞–¥—ã */
        .floating-reward {
            position: absolute;
            font-size: 20px;
            font-weight: bold;
            color: #4cd137;
            text-shadow: 0 0 10px rgba(76, 209, 55, 0.8);
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 60;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.3); }
        }

        /* –ö–æ–º–±–æ */
        #combo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            opacity: 0;
            pointer-events: none;
            z-index: 50;
            text-align: center;
        }

        #combo.show {
            animation: comboAnim 1s ease-out;
        }

        @keyframes comboAnim {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5) translateY(-50px); }
        }

        .combo-bonus {
            font-size: 24px;
            color: #4cd137;
        }

        /* –¢–∞–π–º–µ—Ä –∏–≥—Ä—ã */
        #timer {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
        }

        #timer.warning {
            color: #ff6b6b;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui">
            <div class="stat-box">
                <div class="stat-row">
                    <span>üí∞</span>
                    <span class="money" id="money">0.00 ‚ÇΩ</span>
                </div>
                <div class="stat-row">
                    <span>üéØ</span>
                    <span class="score" id="score">0</span>
                </div>
            </div>
            <div id="lives">
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
            </div>
        </div>

        <div id="timer">‚è±Ô∏è 60</div>
        <div id="combo"></div>

        <div id="menu">
            <div class="menu-title">üçâüí∞</div>
            <h1 style="color: white; font-size: 28px; margin-bottom: 5px;">FRUIT NINJA</h1>
            <p class="menu-subtitle">–†–µ–∂—å —Ñ—Ä—É–∫—Ç—ã ‚Äî –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π —Ä—É–±–ª–∏!</p>
            
            <div class="rewards-table">
                <div class="rewards-title">üíé –ù–ê–ì–†–ê–î–´ –ó–ê –§–†–£–ö–¢–´</div>
                <div class="reward-row">
                    <span class="reward-emoji">üçâ</span>
                    <span class="reward-name">–ê—Ä–±—É–∑</span>
                    <span class="reward-price">+5 ‚ÇΩ</span>
                    <span class="reward-speed">–º–µ–¥–ª.</span>
                </div>
                <div class="reward-row">
                    <span class="reward-emoji">üçá</span>
                    <span class="reward-name">–í–∏–Ω–æ–≥—Ä–∞–¥</span>
                    <span class="reward-price">+3 ‚ÇΩ</span>
                    <span class="reward-speed">—Å—Ä–µ–¥–Ω.</span>
                </div>
                <div class="reward-row">
                    <span class="reward-emoji">üçä</span>
                    <span class="reward-name">–ê–ø–µ–ª—å—Å–∏–Ω</span>
                    <span class="reward-price">+2 ‚ÇΩ</span>
                    <span class="reward-speed">—Å—Ä–µ–¥–Ω.</span>
                </div>
                <div class="reward-row">
                    <span class="reward-emoji">üçé</span>
                    <span class="reward-name">–Ø–±–ª–æ–∫–æ</span>
                    <span class="reward-price">+1 ‚ÇΩ</span>
                    <span class="reward-speed">–±—ã—Å—Ç—Ä.</span>
                </div>
                <div class="reward-row">
                    <span class="reward-emoji">üçã</span>
                    <span class="reward-name">–õ–∏–º–æ–Ω</span>
                    <span class="reward-price">+0.50 ‚ÇΩ</span>
                    <span class="reward-speed">–æ—á.–±—ã—Å—Ç—Ä.</span>
                </div>
                <div class="reward-row">
                    <span class="reward-emoji">‚≠ê</span>
                    <span class="reward-name">–ó–≤–µ–∑–¥–∞</span>
                    <span class="reward-price">+10 ‚ÇΩ</span>
                    <span class="reward-speed">—Ä–µ–¥–∫–∞—è!</span>
                </div>
                <div class="reward-row" style="background: rgba(255,0,0,0.2);">
                    <span class="reward-emoji">üí£</span>
                    <span class="reward-name">–ë–æ–º–±–∞</span>
                    <span class="reward-price" style="color: #ff6b6b;">‚àí50%</span>
                    <span class="reward-speed">–æ–ø–∞—Å–Ω–æ!</span>
                </div>
            </div>
            
            <button class="menu-btn" onclick="startGame()">‚ñ∂Ô∏è –ò–ì–†–ê–¢–¨</button>
        </div>

        <div id="gameOver">
            <div class="game-over-title">üèÅ –†–ê–£–ù–î –û–ö–û–ù–ß–ï–ù!</div>
            
            <div class="earnings-box">
                <div class="earnings-label">–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏:</div>
                <div class="earnings-amount" id="finalMoney">0.00 ‚ÇΩ</div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-value" id="finalFruits">0</div>
                    <div class="stat-card-label">–§—Ä—É–∫—Ç–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="finalCombo">0x</div>
                    <div class="stat-card-label">–ú–∞–∫—Å. –∫–æ–º–±–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="finalAccuracy">0%</div>
                    <div class="stat-card-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="finalBest">0 ‚ÇΩ</div>
                    <div class="stat-card-label">–õ—É—á—à–∏–π</div>
                </div>
            </div>
            
            <button class="menu-btn" onclick="startGame()">üîÑ –ï–©–Å –†–ê–ó</button>
            <button class="menu-btn secondary" onclick="claimReward()">üí∞ –ó–ê–ë–†–ê–¢–¨</button>
        </div>
    </div>

    <script>
        // Telegram Web App
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.expand();
            tg.ready();
        }

        // Canvas setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // === –ù–ê–°–¢–†–û–ô–ö–ò –§–†–£–ö–¢–û–í –ò –ù–ê–ì–†–ê–î ===
        const FRUIT_CONFIG = {
            watermelon: {
                emoji: 'üçâ',
                name: '–ê—Ä–±—É–∑',
                reward: 5.00,        // 5 —Ä—É–±–ª–µ–π
                size: 140,           // x2 —Ä–∞–∑–º–µ—Ä
                color: '#ff6b6b',
                speed: 0.7,          // –ú–µ–¥–ª–µ–Ω–Ω—ã–π (–º–Ω–æ–∂–∏—Ç–µ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏)
                spawnChance: 0.10,   // 10% —à–∞–Ω—Å –ø–æ—è–≤–ª–µ–Ω–∏—è
            },
            grape: {
                emoji: 'üçá',
                name: '–í–∏–Ω–æ–≥—Ä–∞–¥',
                reward: 3.00,
                size: 110,           // x2 —Ä–∞–∑–º–µ—Ä
                color: '#9b59b6',
                speed: 0.85,
                spawnChance: 0.15,
            },
            orange: {
                emoji: 'üçä',
                name: '–ê–ø–µ–ª—å—Å–∏–Ω',
                reward: 2.00,
                size: 100,           // x2 —Ä–∞–∑–º–µ—Ä
                color: '#ffa502',
                speed: 1.0,
                spawnChance: 0.20,
            },
            apple: {
                emoji: 'üçé',
                name: '–Ø–±–ª–æ–∫–æ',
                reward: 1.00,
                size: 90,            // x2 —Ä–∞–∑–º–µ—Ä
                color: '#ee5a24',
                speed: 1.2,          // –ë—ã—Å—Ç—Ä—ã–π
                spawnChance: 0.25,
            },
            lemon: {
                emoji: 'üçã',
                name: '–õ–∏–º–æ–Ω',
                reward: 0.50,
                size: 80,            // x2 —Ä–∞–∑–º–µ—Ä
                color: '#fff200',
                speed: 1.5,          // –û—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π
                spawnChance: 0.25,
            },
            star: {
                emoji: '‚≠ê',
                name: '–ó–≤–µ–∑–¥–∞',
                reward: 10.00,       // 10 —Ä—É–±–ª–µ–π - —Ä–µ–¥–∫–∞—è!
                size: 110,           // x2 —Ä–∞–∑–º–µ—Ä
                color: '#ffd700',
                speed: 1.3,
                spawnChance: 0.05,   // 5% - —Ä–µ–¥–∫–∞—è
            },
        };

        const BOMB = {
            emoji: 'üí£',
            name: '–ë–æ–º–±–∞',
            size: 110,               // x2 —Ä–∞–∑–º–µ—Ä
            color: '#2d3436',
            speed: 1.0,
            spawnChance: 0.10,       // 10% —à–∞–Ω—Å –±–æ–º–±—ã
        };

        // Game settings
        const GAME_DURATION = 60;    // 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Ä–∞—É–Ω–¥
        const COMBO_MULTIPLIER = 0.5; // +50% –∑–∞ –∫–∞–∂–¥—ã–π –∫–æ–º–±–æ —É—Ä–æ–≤–µ–Ω—å

        // Game state
        let gameRunning = false;
        let money = 0;
        let fruitsSliced = 0;
        let fruitsMissed = 0;
        let lives = 3;
        let bestMoney = parseFloat(localStorage.getItem('fruitNinjaBestMoney')) || 0;
        let fruits = [];
        let particles = [];
        let comboCount = 0;
        let maxCombo = 0;
        let lastSliceTime = 0;
        let timeLeft = GAME_DURATION;
        let gameTimer = null;

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ—Ä—É–∫—Ç–∞–º
        let fruitStats = {};

        function getRandomFruit() {
            const rand = Math.random();
            let cumulative = 0;
            
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–æ–º–±—É
            if (rand < BOMB.spawnChance) {
                return { ...BOMB, isBomb: true };
            }
            
            cumulative = BOMB.spawnChance;
            
            // –ó–∞—Ç–µ–º —Ñ—Ä—É–∫—Ç—ã
            for (const [key, fruit] of Object.entries(FRUIT_CONFIG)) {
                cumulative += fruit.spawnChance;
                if (rand < cumulative) {
                    return { ...fruit, key, isBomb: false };
                }
            }
            
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —è–±–ª–æ–∫–æ
            return { ...FRUIT_CONFIG.apple, key: 'apple', isBomb: false };
        }

        class Fruit {
            constructor() {
                this.type = getRandomFruit();
                this.isBomb = this.type.isBomb;
                
                this.x = Math.random() * (canvas.width - 100) + 50;
                this.y = canvas.height + 50;
                this.size = this.type.size;
                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.2;
                
                // –§–∏–∑–∏–∫–∞ —Å —É—á—ë—Ç–æ–º —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ñ—Ä—É–∫—Ç–∞
                const baseSpeed = this.type.speed;
                this.vx = (Math.random() - 0.5) * 8;
                this.vy = (-16 - Math.random() * 6) * baseSpeed;
                this.gravity = 0.35 * baseSpeed;
                
                this.sliced = false;
                this.opacity = 1;
            }

            update() {
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.rotation += this.rotationSpeed;

                if (this.sliced) {
                    this.opacity -= 0.05;
                }

                return this.y < canvas.height + 100 && this.opacity > 0;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.globalAlpha = this.opacity;
                ctx.font = `${this.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // –¢–µ–Ω—å
                ctx.shadowColor = this.type.color;
                ctx.shadowBlur = 20;
                
                ctx.fillText(this.type.emoji, 0, 0);
                ctx.restore();
            }

            checkSlice(x, y) {
                if (this.sliced) return false;
                const dist = Math.hypot(x - this.x, y - this.y);
                return dist < this.size;
            }

            slice() {
                this.sliced = true;
                
                // –ß–∞—Å—Ç–∏—Ü—ã
                for (let i = 0; i < 12; i++) {
                    particles.push(new Particle(this.x, this.y, this.type.color));
                }
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.size = Math.random() * 8 + 4;
                this.vx = (Math.random() - 0.5) * 15;
                this.vy = (Math.random() - 0.5) * 15;
                this.gravity = 0.3;
                this.opacity = 1;
                this.decay = 0.02 + Math.random() * 0.02;
            }

            update() {
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.opacity -= this.decay;
                return this.opacity > 0;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.opacity;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // –°–≤–∞–π–ø
        let isSlicing = false;
        let slicePoints = [];

        function handleStart(e) {
            if (!gameRunning) return;
            isSlicing = true;
            slicePoints = [];
            const pos = getPos(e);
            slicePoints.push({ x: pos.x, y: pos.y, time: Date.now() });
        }

        function handleMove(e) {
            if (!gameRunning || !isSlicing) return;
            e.preventDefault();
            
            const pos = getPos(e);
            slicePoints.push({ x: pos.x, y: pos.y, time: Date.now() });
            
            if (slicePoints.length > 20) {
                slicePoints.shift();
            }

            checkCollisions(pos.x, pos.y);
        }

        function handleEnd() {
            isSlicing = false;
            slicePoints = [];
            comboCount = 0;
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            return {
                x: (touch.clientX - rect.left) * (canvas.width / rect.width),
                y: (touch.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function checkCollisions(x, y) {
            const now = Date.now();

            fruits.forEach(fruit => {
                if (!fruit.sliced && fruit.checkSlice(x, y)) {
                    if (fruit.isBomb) {
                        // –ë–æ–º–±–∞! –¢–µ—Ä—è–µ–º 50% –∑–∞—Ä–∞–±–æ—Ç–∫–∞
                        fruit.slice();
                        const penalty = money * 0.5;
                        money -= penalty;
                        if (money < 0) money = 0;
                        
                        showFloatingText(fruit.x, fruit.y, `-${penalty.toFixed(2)} ‚ÇΩ`, '#ff6b6b');
                        updateUI();
                        
                        // –í–∏–±—Ä–∞—Ü–∏—è –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
                        if (navigator.vibrate) navigator.vibrate(200);
                        return;
                    }

                    fruit.slice();
                    fruitsSliced++;
                    
                    // –ö–æ–º–±–æ
                    if (now - lastSliceTime < 400) {
                        comboCount++;
                        if (comboCount > maxCombo) maxCombo = comboCount;
                        if (comboCount >= 2) {
                            showCombo(comboCount);
                        }
                    } else {
                        comboCount = 1;
                    }
                    lastSliceTime = now;

                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É —Å –∫–æ–º–±–æ
                    let reward = fruit.type.reward;
                    if (comboCount > 1) {
                        reward *= (1 + (comboCount - 1) * COMBO_MULTIPLIER);
                    }
                    
                    money += reward;
                    
                    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    if (fruit.type.key) {
                        fruitStats[fruit.type.key] = (fruitStats[fruit.type.key] || 0) + 1;
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É
                    const comboText = comboCount > 1 ? ` x${comboCount}` : '';
                    showFloatingText(fruit.x, fruit.y, `+${reward.toFixed(2)} ‚ÇΩ${comboText}`, '#4cd137');
                    
                    updateUI();
                }
            });
        }

        function showFloatingText(x, y, text, color) {
            const div = document.createElement('div');
            div.className = 'floating-reward';
            div.textContent = text;
            div.style.left = `${x}px`;
            div.style.top = `${y}px`;
            div.style.color = color;
            document.getElementById('gameContainer').appendChild(div);
            
            setTimeout(() => div.remove(), 1000);
        }

        function showCombo(count) {
            const combo = document.getElementById('combo');
            const bonus = Math.round((count - 1) * COMBO_MULTIPLIER * 100);
            combo.innerHTML = `${count}x COMBO!<br><span class="combo-bonus">+${bonus}% –∫ –Ω–∞–≥—Ä–∞–¥–∞–º</span>`;
            combo.classList.remove('show');
            void combo.offsetWidth;
            combo.classList.add('show');
        }

        function updateUI() {
            document.getElementById('money').textContent = `${money.toFixed(2)} ‚ÇΩ`;
            document.getElementById('score').textContent = fruitsSliced;
        }

        function updateTimer() {
            const timerEl = document.getElementById('timer');
            timerEl.textContent = `‚è±Ô∏è ${timeLeft}`;
            
            if (timeLeft <= 10) {
                timerEl.classList.add('warning');
            }
        }

        function updateLives() {
            const hearts = document.querySelectorAll('.heart');
            hearts.forEach((heart, i) => {
                heart.classList.toggle('lost', i >= lives);
            });
        }

        function spawnFruit() {
            if (!gameRunning) return;
            
            const count = Math.floor(Math.random() * 2) + 1;
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    if (gameRunning) fruits.push(new Fruit());
                }, i * 150);
            }
        }

        function drawSliceTrail() {
            if (slicePoints.length < 2) return;

            ctx.save();
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            for (let i = 1; i < slicePoints.length; i++) {
                const p1 = slicePoints[i - 1];
                const p2 = slicePoints[i];
                const age = Date.now() - p2.time;
                const opacity = Math.max(0, 1 - age / 200);
                const width = Math.max(2, 15 * opacity);

                ctx.beginPath();
                ctx.strokeStyle = `rgba(255, 255, 255, ${opacity})`;
                ctx.lineWidth = width;
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.stroke();

                ctx.beginPath();
                ctx.strokeStyle = `rgba(76, 209, 55, ${opacity * 0.8})`;
                ctx.lineWidth = width * 0.4;
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.stroke();
            }
            ctx.restore();
        }

        let spawnInterval;

        function startGame() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('timer').classList.remove('warning');
            
            money = 0;
            fruitsSliced = 0;
            fruitsMissed = 0;
            lives = 3;
            fruits = [];
            particles = [];
            comboCount = 0;
            maxCombo = 0;
            timeLeft = GAME_DURATION;
            fruitStats = {};
            gameRunning = true;
            
            updateUI();
            updateLives();
            updateTimer();
            
            // –°–ø–∞–≤–Ω —Ñ—Ä—É–∫—Ç–æ–≤
            spawnInterval = setInterval(spawnFruit, 1000);
            
            // –¢–∞–π–º–µ—Ä –∏–≥—Ä—ã
            gameTimer = setInterval(() => {
                timeLeft--;
                updateTimer();
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
            
            gameLoop();
        }

        function endGame() {
            gameRunning = false;
            clearInterval(spawnInterval);
            clearInterval(gameTimer);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (money > bestMoney) {
                bestMoney = money;
                localStorage.setItem('fruitNinjaBestMoney', bestMoney.toFixed(2));
            }
            
            // –¢–æ—á–Ω–æ—Å—Ç—å
            const totalFruits = fruitsSliced + fruitsMissed;
            const accuracy = totalFruits > 0 ? Math.round((fruitsSliced / totalFruits) * 100) : 0;
            
            document.getElementById('finalMoney').textContent = `${money.toFixed(2)} ‚ÇΩ`;
            document.getElementById('finalFruits').textContent = fruitsSliced;
            document.getElementById('finalCombo').textContent = `${maxCombo}x`;
            document.getElementById('finalAccuracy').textContent = `${accuracy}%`;
            document.getElementById('finalBest').textContent = `${bestMoney.toFixed(2)} ‚ÇΩ`;
            document.getElementById('gameOver').style.display = 'flex';
        }

        function claimReward() {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram –±–æ—Ç
            if (tg) {
                const data = {
                    action: 'claim',
                    money: money,
                    fruitsSliced: fruitsSliced,
                    maxCombo: maxCombo,
                    fruitStats: fruitStats,
                };
                tg.sendData(JSON.stringify(data));
                tg.close();
            } else {
                alert(`–ù–∞–≥—Ä–∞–¥–∞: ${money.toFixed(2)} ‚ÇΩ –±—É–¥–µ—Ç –∑–∞—á–∏—Å–ª–µ–Ω–∞ –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å!`);
            }
        }

        function gameLoop() {
            if (!gameRunning) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –ß–∞—Å—Ç–∏—Ü—ã
            particles = particles.filter(p => p.update());
            particles.forEach(p => p.draw());

            // –§—Ä—É–∫—Ç—ã
            fruits = fruits.filter(fruit => {
                const alive = fruit.update();
                
                // –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Ñ—Ä—É–∫—Ç—ã (–Ω–µ –±–æ–º–±—ã)
                if (!alive && !fruit.sliced && !fruit.isBomb) {
                    fruitsMissed++;
                    lives--;
                    updateLives();
                    if (lives <= 0) {
                        endGame();
                        return false;
                    }
                }
                
                fruit.draw();
                return alive;
            });

            // –°–ª–µ–¥
            drawSliceTrail();

            requestAnimationFrame(gameLoop);
        }

        // –°–æ–±—ã—Ç–∏—è
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('mouseleave', handleEnd);

        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd);
        canvas.addEventListener('touchcancel', handleEnd);
    </script>
</body>
</html>
